// ==UserScript==
// @name TrollCam
// @description we do a little trolling
// @version 1.0.0
// @author crackbob
// @homepage https://github.com/crackbob/TrollCam
// @supportURL https://github.com/crackbob/TrollCam
// @match *://app.zoom.us/*
// @grant none
// ==/UserScript==

(()=>{function e(e){const t=document.createElement("div");Object.assign(t.style,{zIndex:"999999",position:"fixed",top:"50px",right:"50px",width:"400px",backgroundColor:"rgb(12 12 12)",border:"1px solid #ccc",borderRadius:"8px",boxShadow:"0 4px 10px rgba(0, 0, 0, 0.1)",padding:"16px",color:"white"});const n=document.createElement("h3");n.textContent="TrollCam",n.style.marginTop="0",n.style.marginBottom="12px",t.appendChild(n);const o=document.createElement("div");Object.assign(o.style,{width:"100%",aspectRatio:"16 / 9",border:"1px solid #ccc",borderRadius:"6px",overflow:"hidden",background:"#000",marginBottom:"12px"});const d=document.createElement("video");Object.assign(d,{controls:!0,loop:!0}),Object.assign(d.style,{width:"100%",height:"100%",backgroundColor:"#000"}),o.appendChild(d),t.appendChild(o);const i=document.createElement("ul");Object.assign(i.style,{listStyle:"none",padding:"0",margin:"0 0 12px 0",maxHeight:"120px",overflowY:"auto",borderTop:"1px solid #eee",borderBottom:"1px solid #eee"}),t.appendChild(i);const a=document.createElement("button");a.textContent="Add Video",Object.assign(a.style,{width:"100%",padding:"10px",border:"none",borderRadius:"4px",backgroundColor:"#007BFF",color:"#fff",cursor:"pointer",fontSize:"14px"}),a.onmouseover=()=>a.style.backgroundColor="#0056b3",a.onmouseout=()=>a.style.backgroundColor="#007BFF",t.appendChild(a),e.document.body.appendChild(t);const c=document.createElement("input");c.type="file",c.accept="video/*",c.style.display="none",e.document.body.appendChild(c),a.addEventListener("click",(()=>c.click()));let l=[],s=-1;const r=document.createElement("canvas");r.width=640,r.height=360,r.style.display="none",e.document.body.appendChild(r);const p=r.getContext("2d"),u=r.captureStream(30);let m=u.getVideoTracks()[0],g=new MediaStream,b=null;const v=new AudioContext;function x(e){d.pause(),d.src=e,d.load(),d.play();const t=()=>{d.paused||d.ended||(p.drawImage(d,0,0,r.width,r.height),requestAnimationFrame(t))};t(),d.onloadedmetadata=()=>{const e=d.captureStream(),t=e.getAudioTracks()[0];t&&(g.addTrack(t),b=t,v.createMediaStreamSource(e).connect(v.destination))}}c.addEventListener("change",(()=>{const e=c.files[0];if(!e)return;const t=new FileReader;t.onload=function(t){const n=t.target.result;l.push({url:n,name:e.name});const o=document.createElement("li");o.textContent=e.name,Object.assign(o.style,{padding:"6px 10px",cursor:"pointer",borderRadius:"4px"}),o.onmouseover=()=>o.style.backgroundColor="#161616",o.onmouseout=()=>o.style.backgroundColor="transparent",o.onclick=()=>{s=l.findIndex((e=>e.url===n)),x(n)},i.appendChild(o),1===l.length&&x(n)},t.readAsDataURL(e)}));let y=Math.random().toString(36).substring(2,15),h=Math.random().toString(36).substring(2,15);e.navigator.mediaDevices.enumerateDevices,e.navigator.mediaDevices.enumerateDevices=async function(){let e=[];return e.push({kind:"videoinput",label:"TrollCam",deviceId:y,groupId:y,getCapabilities:()=>m?.getCapabilities()||{},toJSON(){return{deviceId:this.deviceId,groupId:this.groupId,kind:this.kind,label:this.label}}},{kind:"audioinput",label:"TrollMic",deviceId:h,groupId:h,getCapabilities:()=>b?.getCapabilities()||{},toJSON(){return{deviceId:this.deviceId,groupId:this.groupId,kind:this.kind,label:this.label}}}),e};let f=e.navigator.mediaDevices.getUserMedia;e.navigator.mediaDevices.getUserMedia=async function(t){if(!t)return f.call(e.navigator.mediaDevices,t);let n=t.video?.deviceId?.exact||t.video?.deviceId,o=t.audio?.deviceId?.exact||t.audio?.deviceId,d=new MediaStream;return n===y&&u.getVideoTracks().forEach((e=>d.addTrack(e))),o===h&&g.getAudioTracks().forEach((e=>d.addTrack(e))),0===d.getTracks().length?f.call(navigator.mediaDevices,t):d};let C=document.createElement("div");C.textContent="ðŸ“·",C.style.position="fixed",C.style.top="100px",C.style.left="0px",C.style.padding="10px 10px",C.style.backgroundColor="rgba(25, 25, 25, 0.75)",C.style.border="1px solid rgb(0, 123, 255)",C.style.color="#fff",C.style.borderRadius="0 5px 5px 0",C.style.cursor="pointer",C.style.zIndex="9999999",C.style.userSelect="none",C.addEventListener("click",(function(){"none"===t.style.display?t.style.display="block":t.style.display="none"}));let k=!1,w=0;C.addEventListener("mousedown",(function(e){k=!0,w=e.clientY-C.getBoundingClientRect().top,e.preventDefault()})),e.document.addEventListener("mousemove",(function(e){k&&(C.style.top=e.clientY-w+"px")})),e.document.addEventListener("mouseup",(function(){k=!1})),e.document.body.appendChild(C);let E=!1,I=0,S=0;t.addEventListener("mousedown",(function(e){E=!0,I=e.clientX-t.getBoundingClientRect().left,S=e.clientY-t.getBoundingClientRect().top,e.preventDefault()})),e.document.addEventListener("mousemove",(function(e){E&&(t.style.left=e.clientX-I+"px",t.style.top=e.clientY-S+"px")})),e.document.addEventListener("mouseup",(function(){E=!1})),Object.assign(t.style,{left:"50px",top:"50px"})}function t(){if("app.zoom.us"!=location.host||top?.injected)"app.zoom.us"!==location.host&&e(window);else{let t=document.getElementById("webclient");t?.contentWindow?(e(t?.contentWindow),top.injected=!0):(e(window),top.injected=!0)}}"complete"==document.readyState?t():window.onload=t})();