// ==UserScript==
// @name TrollCam
// @description we do a little trolling
// @version 1.0.0
// @author crackbob
// @homepage https://github.com/crackbob/TrollCam
// @supportURL https://github.com/crackbob/TrollCam
// @match *://app.zoom.us/*
// @grant none
// ==/UserScript==

(()=>{const e=document.createElement("div");Object.assign(e.style,{zIndex:"999999",position:"fixed",top:"50px",right:"50px",width:"400px",backgroundColor:"rgb(12 12 12)",border:"1px solid #ccc",borderRadius:"8px",boxShadow:"0 4px 10px rgba(0, 0, 0, 0.1)",padding:"16px",color:"white"});const t=document.createElement("h3");t.textContent="TrollCam",t.style.marginTop="0",t.style.marginBottom="12px",e.appendChild(t);const n=document.createElement("div");Object.assign(n.style,{width:"100%",aspectRatio:"16 / 9",border:"1px solid #ccc",borderRadius:"6px",overflow:"hidden",background:"#000",marginBottom:"12px"});const o=document.createElement("video");Object.assign(o,{controls:!0,loop:!0}),Object.assign(o.style,{width:"100%",height:"100%",backgroundColor:"#000"}),n.appendChild(o),e.appendChild(n);const d=document.createElement("ul");Object.assign(d.style,{listStyle:"none",padding:"0",margin:"0 0 12px 0",maxHeight:"120px",overflowY:"auto",borderTop:"1px solid #eee",borderBottom:"1px solid #eee"}),e.appendChild(d);const i=document.createElement("button");i.textContent="Add Video",Object.assign(i.style,{width:"100%",padding:"10px",border:"none",borderRadius:"4px",backgroundColor:"#007BFF",color:"#fff",cursor:"pointer",fontSize:"14px"}),i.onmouseover=()=>i.style.backgroundColor="#0056b3",i.onmouseout=()=>i.style.backgroundColor="#007BFF",e.appendChild(i),document.body.appendChild(e);const a=document.createElement("input");a.type="file",a.accept="video/*",a.style.display="none",document.body.appendChild(a),i.addEventListener("click",(()=>a.click()));let r=[],l=null;const c=document.createElement("canvas");c.width=640,c.height=360,c.style.display="none",document.body.appendChild(c);const s=c.getContext("2d"),p=c.captureStream(30);let u=p.getVideoTracks()[0],g=new MediaStream,m=null;const b=new AudioContext;function v(e){o.pause(),o.src=e,o.load(),o.play();const t=()=>{o.paused||o.ended||(s.drawImage(o,0,0,c.width,c.height),requestAnimationFrame(t))};t(),o.onloadedmetadata=()=>{const e=o.captureStream(),t=e.getAudioTracks()[0];t&&(m&&g.removeTrack(m),g.addTrack(t),m=t,b.createMediaStreamSource(e).connect(b.destination))}}a.addEventListener("change",(()=>{const e=a.files[0];if(!e)return;const t=new FileReader;t.onload=function(t){const n=t.target.result;r.push({url:n,name:e.name});const o=document.createElement("li");o.textContent=e.name,Object.assign(o.style,{padding:"6px 10px",cursor:"pointer",borderRadius:"4px"}),o.onmouseover=()=>o.style.backgroundColor="#161616",o.onmouseout=()=>o.style.backgroundColor="transparent",o.onclick=()=>{l=r.findIndex((e=>e.url===n)),v(n)},d.appendChild(o),1===r.length&&v(n)},t.readAsDataURL(e)}));let x=Math.random().toString(36).substring(2,15),y=Math.random().toString(36).substring(2,15);navigator.mediaDevices.enumerateDevices,navigator.mediaDevices.enumerateDevices=async function(){let e=[];return e.push({kind:"videoinput",label:"TrollCam",deviceId:x,groupId:x,getCapabilities:()=>u?.getCapabilities()||{},toJSON(){return{deviceId:this.deviceId,groupId:this.groupId,kind:this.kind,label:this.label}}},{kind:"audioinput",label:"TrollMic",deviceId:y,groupId:y,getCapabilities:()=>m?.getCapabilities()||{},toJSON(){return{deviceId:this.deviceId,groupId:this.groupId,kind:this.kind,label:this.label}}}),e};let h=navigator.mediaDevices.getUserMedia;navigator.mediaDevices.getUserMedia=async function(e){if(!e)return h.call(navigator.mediaDevices,e);let t=e.video?.deviceId?.exact||e.video?.deviceId,n=e.audio?.deviceId?.exact||e.audio?.deviceId,o=new MediaStream;return t===x&&p.getVideoTracks().forEach((e=>o.addTrack(e))),n===y&&g.getAudioTracks().forEach((e=>o.addTrack(e))),0===o.getTracks().length?h.call(navigator.mediaDevices,e):o};let f=document.createElement("div");f.textContent="ðŸ“·",f.style.position="fixed",f.style.top="100px",f.style.left="0px",f.style.padding="10px 10px",f.style.backgroundColor="rgba(25, 25, 25, 0.75)",f.style.border="1px solid rgb(0, 123, 255)",f.style.color="#fff",f.style.borderRadius="0 5px 5px 0",f.style.cursor="pointer",f.style.zIndex="9999999",f.style.userSelect="none",f.addEventListener("click",(function(){"none"===e.style.display?e.style.display="block":e.style.display="none"}));let C=!1,k=0;f.addEventListener("mousedown",(function(e){C=!0,k=e.clientY-f.getBoundingClientRect().top,e.preventDefault()})),document.addEventListener("mousemove",(function(e){C&&(f.style.top=e.clientY-k+"px")})),document.addEventListener("mouseup",(function(){C=!1})),document.body.appendChild(f);let E=!1,I=0,w=0;e.addEventListener("mousedown",(function(t){E=!0,I=t.clientX-e.getBoundingClientRect().left,w=t.clientY-e.getBoundingClientRect().top,t.preventDefault()})),document.addEventListener("mousemove",(function(t){E&&(e.style.left=t.clientX-I+"px",e.style.top=t.clientY-w+"px")})),document.addEventListener("mouseup",(function(){E=!1})),Object.assign(e.style,{left:"50px",top:"50px"})})();